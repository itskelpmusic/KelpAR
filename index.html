<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zappar ThreeJS + Cloudflare GLB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #status {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 8px 12px;
      color: #fff;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      border-radius: 4px;
      z-index: 10;
    }
  </style>

  <!-- Three.js r128 (matches the docs examples) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <!-- GLTFLoader matching r128 -->
  <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

  <!-- Zappar for ThreeJS -->
  <script src="https://cdn.zappar.io/v1/zappar-threejs.min.js"></script>
</head>

<body>
  <div id="status">Status: loading…</div>

  <script>
    const statusEl = document.getElementById("status");
    function setStatus(msg) {
      console.log(msg);
      if (statusEl) statusEl.textContent = "Status: " + msg;
    }

    // --- BASIC THREE + ZAPPAR SETUP ---
    const scene = new THREE.Scene();

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Let Zappar know about our GL context
    ZapparThree.glContextSet(renderer.getContext());

    // Zappar camera (this handles the video background + tracking)
    const camera = new ZapparThree.Camera();
    scene.background = camera.backgroundTexture;

    // Simple light so the model isn't black
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    hemi.position.set(0, 1, 0);
    scene.add(hemi);

    // Handle resize
    window.addEventListener("resize", () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Ask for camera permission and start
    setStatus("requesting camera permission…");
    ZapparThree.permissionRequestUI().then((granted) => {
      if (granted) {
        camera.start();
        setStatus("camera started – point at target image");
      } else {
        ZapparThree.permissionDeniedUI();
        setStatus("camera permission denied");
      }
    });

    // --- IMAGE TRACKER using your polygon.zpt ---
    // polygon.zpt must be in ./assets/polygon.zpt relative to this HTML file
    const imageTracker = new ZapparThree.ImageTrackerLoader().load("assets/polygon.zpt");
    const imageAnchorGroup = new ZapparThree.ImageAnchorGroup(camera, imageTracker);
    scene.add(imageAnchorGroup);

    // Log when the target has actually loaded
    imageTracker.loadTarget("assets/polygon.zpt").then(() => {
      console.log("Target file polygon.zpt loaded");
    });

    // --- TEST CUBE to check tracking visually ---
    const testGeom = new THREE.BoxGeometry(0.25, 0.25, 0.25);
    const testMat = new THREE.MeshNormalMaterial();
    const testCube = new THREE.Mesh(testGeom, testMat);
    testCube.position.set(0, 0, 0.2); // 20cm above the image
    testCube.visible = false;
    imageAnchorGroup.add(testCube);

    // --- GLB MODEL FROM CLOUDFLARE ---
    const loader = new THREE.GLTFLoader();
    let model = null;

    const GLB_URL = "https://frosty-union-c144.itskelpmusic.workers.dev/Lamesh.glb";

    setStatus("loading GLB…");

    loader.load(
      GLB_URL,
      (gltf) => {
        model = gltf.scene;

        // Big environment, so start with a relatively big scale; tweak as needed
        model.scale.set(0.2, 0.2, 0.2);

        // Center the model on the image origin (optional – depends on how it was authored)
        const box = new THREE.Box3().setFromObject(model);
        const center = box.getCenter(new THREE.Vector3());
        model.position.sub(center); // shift so center is at (0,0,0)

        model.visible = false;
        imageAnchorGroup.add(model);

        setStatus("model loaded – point at target image");
        console.log("GLB model added to imageAnchorGroup");
      },
      (xhr) => {
        if (xhr.total) {
          const pct = (xhr.loaded / xhr.total) * 100;
          setStatus("downloading model: " + pct.toFixed(1) + "%");
        } else {
          setStatus("downloading model…");
        }
      },
      (err) => {
        console.error("Error loading GLB:", err);
        setStatus("failed to load model");
      }
    );

    // --- VISIBILITY EVENTS (image in view / out of view) ---
    imageTracker.onVisible.bind((anchor) => {
      setStatus("target found");
      imageAnchorGroup.visible = true;
      testCube.visible = true;   // good debugging reference
      if (model) model.visible = true;
    });

    imageTracker.onNotVisible.bind((anchor) => {
      setStatus("target lost – keep camera on image");
      testCube.visible = false;
      if (model) model.visible = false;
      // You can keep imageAnchorGroup.visible = true if you want the model to "stick" after detection.
      // For now we'll hide it when the image is lost:
      imageAnchorGroup.visible = false;
    });

    // --- ANIMATION LOOP ---
    function animate() {
      requestAnimationFrame(animate);

      // Zappar camera update each frame
      camera.updateFrame(renderer);

      // Small rotation on the debug cube so you can see it's alive
      if (testCube.visible) {
        testCube.rotation.y += 0.02;
      }

      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>
</html>
