<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KelpAR — Zappar WebAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background: #000;
    }

    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      padding: 8px 12px;
      background: rgba(0,0,0,0.4);
      z-index: 10;
      font-size: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="status">Status: loading…</div>
  <canvas id="canvas"></canvas>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.152.2/build/three.module.js";
    import * as ZapparThree from "https://libs.zappar.com/zappar-threejs/2.2.0/module.js";

    const statusEl = document.getElementById("status");
    const setStatus = (msg) => {
      console.log(msg);
      statusEl.textContent = "Status: " + msg;
    };

    setStatus("initializing…");

    // ---------- Renderer ----------
    const canvas = document.getElementById("canvas");
    const renderer = new THREE.WebGLRenderer({
      canvas,
      alpha: true,
      antialias: true,
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);

    // Let Zappar hook into this GL context
    ZapparThree.glContextSet(renderer.getContext());

    // ---------- Camera + Scene ----------
    const camera = new ZapparThree.Camera();
    const scene = new THREE.Scene();
    scene.background = camera.backgroundTexture;
    scene.add(camera);

    window.addEventListener("resize", () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // ---------- Image Tracker ----------
    const tracker = new ZapparThree.ImageTrackerLoader().load("./assets/polygon.zpt");
    const anchor = new ZapparThree.ImageAnchorGroup(camera, tracker);
    scene.add(anchor);

    // Debug cube to prove tracking works
    const cube = new THREE.Mesh(
      new THREE.BoxGeometry(0.2, 0.2, 0.2),
      new THREE.MeshNormalMaterial()
    );
    cube.visible = false;
    anchor.add(cube);

    tracker.onVisible.bind(() => {
      cube.visible = true;
      setStatus("target found");
    });

    tracker.onNotVisible.bind(() => {
      cube.visible = false;
      setStatus("target lost");
    });

    // ---------- Start AR ----------
    async function start() {
      setStatus("requesting camera permission…");

      const granted = await ZapparThree.permissionRequestUI();

      if (!granted) {
        ZapparThree.permissionDeniedUI();
        setStatus("camera permission denied");
        return;
      }

      ZapparThree.permissionGrantedUI();
      camera.start();

      setStatus("camera started — point at target");

      function animate() {
        camera.updateFrame(renderer);
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }

      animate();
    }

    start().catch((err) => {
      console.error(err);
      setStatus("error: " + err.message);
    });
  </script>
</body>
</html>
