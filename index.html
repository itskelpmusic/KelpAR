<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KelpAR — Zappar WebAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background: #000;
    }
    #zappar-container {
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      padding: 8px 12px;
      background: rgba(0,0,0,0.4);
      z-index: 10;
      font-family: sans-serif;
      font-size: 16px;
    }
  </style>

  <!-- Zappar JS libraries (REQUIRED) -->
  <script src="https://libs.zappar.com/zappar/2.2.0/zappar.js"></script>
  <script src="https://libs.zappar.com/zappar-threejs/2.2.0/zappar-threejs.js"></script>

  <!-- THREE.js (must load BEFORE using ZapparThree) -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
</head>

<body>
  <div id="status">Status: loading…</div>
  <canvas id="zappar-container"></canvas>

<script>
  const statusEl = document.getElementById("status");
  const setStatus = (t) => statusEl.textContent = "Status: " + t;

  // Register service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./zappar-service-worker.js")
      .then(() => console.log("Service worker registered"))
      .catch(e => console.warn("SW registration failed", e));
  }

  // Setup Zappar
  const renderer = new THREE.WebGLRenderer({
    canvas: document.getElementById("zappar-container"),
    antialias: true,
    alpha: true
  });

  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);

  const camera = new ZapparThree.Camera();
  const scene = new THREE.Scene();
  scene.add(camera);

  // Load your image target file
  const imageTracker = new ZapparThree.ImageTrackerLoader().load("./assets/polygon.zpt");
  const imageAnchor = new ZapparThree.ImageAnchorGroup(camera, imageTracker);
  scene.add(imageAnchor);

  // Debug: Add a test cube so we SEE tracking works
  const geo = new THREE.BoxGeometry(0.2,0.2,0.2);
  const mat = new THREE.MeshNormalMaterial();
  const cube = new THREE.Mesh(geo, mat);
  cube.visible = false;
  imageAnchor.add(cube);

  // Tracker events
  imageTracker.onVisible.bind(() => {
    setStatus("target found");
    cube.visible = true;
  });

  imageTracker.onNotVisible.bind(() => {
    setStatus("target lost");
    cube.visible = false;
  });

  // Start the camera
  ZapparThree.permissionRequestUI().then((granted) => {
    if (granted) {
      ZapparThree.permissionGrantedUI();
      camera.start();
      animate();
    } else {
      ZapparThree.permissionDeniedUI();
    }
  });

  function animate(){
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }

  setStatus("ready — point at the target image");
</script>

</body>
</html>
